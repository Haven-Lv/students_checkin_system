<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ´»åŠ¨ç­¾åˆ°</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“</text></svg>">
    <script type="text/javascript">
        window._AMapSecurityConfig = {
           serviceHost: 'https://havenchannel.xyz/_AMapService',
        }
    </script>
    <script type="text/javascript" 
            src="https://webapi.amap.com/maps?v=2.0&key=3b5f49eb59da5745a5f054734d1d5889"> // æ›¿æ¢ä¸ºæ‚¨çš„ Key
    </script>

    <style>
        /* æ ·å¼è¡¨ (ä¿æŒä¸å˜) */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        #container {
            width: 100%;
            max-width: 500px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #eee;
        }
        header h2 {
            margin: 0;
            color: #007bff;
            font-size: 1.5rem;
            text-align: center;
        }
        main {
            padding: 1rem 2rem 2rem 2rem;
        }
        .info-group {
            margin-bottom: 1rem;
            font-size: 1rem;
            color: #555;
        }
        .info-group strong {
            color: #333;
            min-width: 50px;
            display: inline-block;
        }
        #map {
            width: 100%;
            height: 250px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-top: 1rem;
        }
        /* ç§»é™¤äº† .form-group è¾“å…¥æ¡†æ ·å¼ï¼Œå› ä¸ºä¸å†éœ€è¦è¾“å…¥å­¦å·å§“å */
        
        button {
            width: 100%;
            padding: 0.85rem;
            font-size: 1.1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-top: 1rem; /* ç¨å¾®å¢åŠ é¡¶éƒ¨é—´è· */
        }
        #checkInButton {
            background-color: #007bff;
            color: white;
        }
        #checkInButton:hover {
            background-color: #0056b3;
        }
        #checkInButton:disabled {
            background-color: #a0a0a0;
        }
        #checkOutButton {
            background-color: #dc3545;
            color: white;
        }
        #checkOutButton:hover {
            background-color: #c82333;
        }
        #checkOutButton:disabled {
            background-color: #a0a0a0;
        }
        #message {
            text-align: center;
            padding: 1rem 0 0 0;
            font-weight: bold;
            font-size: 0.9rem;
            word-wrap: break-word;
        }
        .success { color: green; }
        .error { color: red; }
        
        #loading {
            padding: 3rem;
            text-align: center;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <div id="container">
        
        <div id="loading">
            <div class="loader"></div>
            <p>æ­£åœ¨åŠ è½½æ´»åŠ¨ä¿¡æ¯...</p>
        </div>
        
        <div id="content" style="display:none;">
            <header>
                <h2 id="activityName"></h2>
            </header>
            
            <main>
                <div id="activityInfo">
                    <div class="info-group">
                        <strong title="åœ°ç‚¹">åœ°ç‚¹:</strong> <span id="activityLocation"></span>
                    </div>
                    <div class="info-group">
                        <strong title="æ—¶é—´">æ—¶é—´:</strong> <span id="activityTime"></span>
                    </div>
                    <div id="map"></div>
                </div>

                <div id="checkInForm" style="display:none;">
                    <h3 style="text-align: center;">ç‚¹å‡»æŒ‰é’®è¿›è¡Œç­¾åˆ°</h3>
                    <button id="checkInButton">ç«‹å³ç­¾ åˆ°</button>
                </div>

                <div id="checkOutForm" style="display:none;">
                    <h3>æ‚¨å·²ç­¾åˆ°</h3>
                    <p>å¦‚éœ€ç­¾é€€ï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ã€‚</p>
                    <button id="checkOutButton">ç­¾ é€€</button>
                </div>

                <div id="message"></div>
            </main>
        </div>
    </div>

    <script>
        // --- æ ¸å¿ƒJSé€»è¾‘ ---
        // ä¿®æ”¹ç‚¹ï¼šå…¨å±€å˜é‡ä¸­è·å– Token
        const studentToken = localStorage.getItem('student_token');
        const urlParams = new URLSearchParams(window.location.search);
        const activityCode = urlParams.get('code');
        const tokenStorageKey = `device_session_token_${activityCode}`; // ç”¨äºå­˜å‚¨ç­¾é€€ç”¨çš„ä¸´æ—¶Token

        // DOM å…ƒç´ 
        const loadingDiv = document.getElementById('loading');
        const contentDiv = document.getElementById('content');
        const checkInForm = document.getElementById('checkInForm');
        const checkOutForm = document.getElementById('checkOutForm');
        const messageDiv = document.getElementById('message');
        const checkInButton = document.getElementById('checkInButton');
        const checkOutButton = document.getElementById('checkOutButton');

        // åœ°å›¾å˜é‡
        var map;
        var activityCircle;
        var activityMarker;
        var studentMarker;
        var amapGeolocation; 

        // åœ¨é¡µé¢åŠ è½½æ—¶è¿è¡Œ
        document.addEventListener('DOMContentLoaded', async () => {
            // 1. åŸºç¡€æ£€æŸ¥
            if (!studentToken) {
                window.location.href = `student_login.html?redirect_code=${activityCode || ''}`;
                return;
            }

            if (!activityCode) {
                showMessage('æ— æ•ˆçš„æ´»åŠ¨é“¾æ¥', true);
                loadingDiv.style.display = 'none';
                return;
            }

            try {
                // 2. å¹¶è¡Œè¯·æ±‚ï¼šè·å–æ´»åŠ¨ä¿¡æ¯ + è·å–ç”¨æˆ·ç­¾åˆ°çŠ¶æ€ (Cloud Sync!)
                const [actResp, statusResp] = await Promise.all([
                    fetch(`/students_system/api/participant/activity/${activityCode}`),
                    fetch(`/students_system/api/participant/status`, {
                        headers: { 'Authorization': `Bearer ${studentToken}` }
                    })
                ]);

                // å¤„ç†æ´»åŠ¨ä¿¡æ¯
                if (!actResp.ok) throw new Error('æ´»åŠ¨åŠ è½½å¤±è´¥');
                const activity = await actResp.json();
                
                // å¡«å……é¡µé¢
                document.getElementById('activityName').innerText = activity.name;
                document.getElementById('activityLocation').innerText = activity.location_name;
                document.getElementById('activityTime').innerText = `${new Date(activity.start_time).toLocaleString()} - ${new Date(activity.end_time).toLocaleString()}`;
                
                if (activity.longitude != null) initMap(activity);

                // 3. å¤„ç†ç­¾åˆ°çŠ¶æ€ (æ ¸å¿ƒä¿®æ”¹)
                const statusData = await statusResp.json();
                
                // å¦‚æœæœåŠ¡å™¨è¯´â€œå·²ç­¾åˆ°â€ï¼Œä¸ç®¡æœ¬åœ°æœ‰æ²¡æœ‰ Tokenï¼Œéƒ½æ˜¾ç¤ºç­¾é€€ç•Œé¢
                if (statusData.is_checked_in) {
                    // åªæœ‰å½“æœåŠ¡å™¨è¿”å›çš„æ´»åŠ¨æ­£æ˜¯å½“å‰æ‰«ç çš„æ´»åŠ¨æ—¶ï¼Œæ‰å…è®¸ç­¾é€€
                    if (statusData.activity_code === activityCode) {
                        checkInForm.style.display = 'none';
                        checkOutForm.style.display = 'block';
                        showMessage('æ£€æµ‹åˆ°æ‚¨å·²åœ¨å…¶ä»–è®¾å¤‡ç­¾åˆ°ï¼Œå¯ç›´æ¥ç­¾é€€', false);
                    } else {
                        // æ­£åœ¨è¿›è¡Œ A æ´»åŠ¨ï¼Œå´æ‰«äº† B æ´»åŠ¨çš„ç 
                        checkInForm.style.display = 'none';
                        checkOutForm.style.display = 'none';
                        showMessage(`æ‚¨æ­£åœ¨å‚ä¸ "${statusData.activity_name}"ï¼Œæ— æ³•åœ¨æ­¤ç­¾åˆ°/ç­¾é€€`, true);
                    }
                } else {
                    // æ²¡ç­¾åˆ°
                    checkInForm.style.display = 'block';
                    checkOutForm.style.display = 'none';
                }

            } catch (error) {
                showMessage(`åŠ è½½å¤±è´¥: ${error.message}`, true);
                if (error.message.includes('401')) { // å¦‚æœ Token å¤±æ•ˆ
                    localStorage.removeItem('student_token');
                    window.location.href = `student_login.html?redirect_code=${activityCode}`;
                }
            }
            
            loadingDiv.style.display = 'none';
            contentDiv.style.display = 'block';
        });

        // åœ°å›¾åˆå§‹åŒ– (ä¿æŒä¸å˜)
        function initMap(activity) {
            const center = [activity.longitude, activity.latitude];
            map = new AMap.Map('map', {
                zoom: 16,
                center: center
            });

            AMap.plugin(['AMap.Circle', 'AMap.Marker', 'AMap.Geolocation'], function() {
                activityMarker = new AMap.Marker({ position: center, title: activity.location_name });
                map.add(activityMarker);

                activityCircle = new AMap.Circle({
                    center: center,
                    radius: activity.radius_meters,
                    borderWeight: 2,
                    strokeColor: "#007bff",
                    strokeOpacity: 1,
                    fillColor: "#007bff",
                    fillOpacity: 0.2,
                    zIndex: 50,
                });
                map.add(activityCircle);
                map.setFitView([activityCircle]);

                studentMarker = new AMap.Marker({
                    icon: "https://webapi.amap.com/theme/v1.3/markers/n/loc.png",
                    offset: new AMap.Pixel(-13, -30)
                });
                map.add(studentMarker);

                amapGeolocation = new AMap.Geolocation({
                    enableHighAccuracy: true, 
                    timeout: 10000,           
                    maximumAge: 0,            
                    convert: true,           
                    extensions: 'all',        
                    showButton: false,        
                    showMarker: false,        
                    showCircle: false,        
                });
                getCurrentStudentPosition();
            });
        }
        
        function updateStudentPosition(lat, lon) {
            if (studentMarker) {
                const position = new AMap.LngLat(lon, lat);
                studentMarker.setPosition(position);
                studentMarker.show();
            }
        }
        
        function getCurrentStudentPosition() {
            // ä»…æ˜¾ç¤ºçŠ¶æ€ï¼Œä¸æç¤ºé”™è¯¯ï¼ˆé”™è¯¯åœ¨ç‚¹å‡»æŒ‰é’®æ—¶å¤„ç†ï¼‰
            if (amapGeolocation) {
                amapGeolocation.getCurrentPosition(function(status, result) {
                    if (status === 'complete' && result.info === 'SUCCESS') {
                        const lat = result.position.lat;
                        const lon = result.position.lng; 
                        updateStudentPosition(lat, lon);
                        if (map && studentMarker) map.setCenter(studentMarker.getPosition());
                    }
                });
            }
        }

        // --- ç­¾åˆ°é€»è¾‘ ---
        // ä¿®æ”¹ç‚¹ï¼šä¸å†éªŒè¯è¾“å…¥æ¡†ï¼Œç›´æ¥æ‰§è¡Œæ“ä½œ
        checkInButton.addEventListener('click', () => {
            performAction('checkin', {}); 
        });

        // --- ç­¾é€€é€»è¾‘ ---
        checkOutButton.addEventListener('click', () => {
            // ä¿®æ”¹ï¼šè·¨è®¾å¤‡ç­¾é€€ä¸éœ€è¦æœ¬åœ° deviceTokenï¼Œç›´æ¥å‘èµ·è¯·æ±‚
            // èº«ä»½éªŒè¯ç°åœ¨ç”± Authorization Header (studentToken) è´Ÿè´£
            performAction('checkout', {}); 
        });

        // 8. ç»Ÿä¸€çš„åŠ¨ä½œæ‰§è¡Œå™¨ (æ ¸å¿ƒä¿®æ”¹)
        function performAction(type, payload) {
            showMessage('æ­£åœ¨è·å–æ‚¨çš„ä½ç½®ä¿¡æ¯...', false);
            checkInButton.disabled = true;
            checkOutButton.disabled = true;

            if (!amapGeolocation) {
                showMessage('å®šä½æ’ä»¶æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢', true);
                checkInButton.disabled = false;
                checkOutButton.disabled = false;
                return;
            }

            amapGeolocation.getCurrentPosition(async function(status, result) {
                if (status === 'complete' && result.info === 'SUCCESS') {
                    const lat = result.position.lat;
                    const lon = result.position.lng;
                    
                    updateStudentPosition(lat, lon);
                    showMessage(`ä½ç½®è·å–æˆåŠŸ (ç²¾åº¦: ${result.accuracy || 'æœªçŸ¥'} ç±³)ï¼Œæ­£åœ¨æäº¤...`, false);

                    // å‡†å¤‡å‘èµ·è¯·æ±‚
                    let response;
                    let resultData;
                    
                    // è·å– Token (ç¡®ä¿å·²å®šä¹‰)
                    const studentToken = localStorage.getItem('student_token');

                    try {
                        if (type === 'checkin') {
                            // --- ç­¾åˆ°è¯·æ±‚ ---
                            response = await fetch('/students_system/api/participant/checkin-auth', {
                                method: 'POST',
                                headers: { 
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${studentToken}`
                                },
                                body: JSON.stringify({
                                    activity_code: activityCode,
                                    latitude: lat,
                                    longitude: lon
                                })
                            });
                        } else {
                            // --- ç­¾é€€è¯·æ±‚ (ä¿®å¤ç‚¹ï¼šç›´æ¥èµ‹å€¼ç»™ responseï¼Œä¸è¦ç”¨ const) ---
                            response = await fetch('/students_system/api/participant/checkout-auth', {
                                method: 'POST',
                                headers: { 
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${studentToken}`
                                },
                                body: JSON.stringify({
                                    activity_code: activityCode,
                                    latitude: lat,
                                    longitude: lon
                                })
                            });
                        }

                        // --- ç»Ÿä¸€å“åº”å¤„ç† (ç­¾åˆ°/ç­¾é€€å…±ç”¨) ---
                        
                        // 1. å°è¯•è§£æ JSONï¼Œé˜²æ­¢è§£æç©ºå“åº”æŠ¥é”™
                        try {
                            resultData = await response.json();
                        } catch (e) {
                            resultData = {}; 
                        }

                        // 2. å¤„ç† 401 æœªæˆæƒ (Tokenè¿‡æœŸ)
                        if (response.status === 401) {
                            await Swal.fire({
                                icon: 'warning',
                                title: 'ä¼šè¯å·²è¿‡æœŸ',
                                text: 'è¯·é‡æ–°ç™»å½•ä»¥ç»§ç»­æ“ä½œ',
                                confirmButtonText: 'å»ç™»å½•',
                                confirmButtonColor: '#007bff',
                                allowOutsideClick: false
                            });
                            localStorage.removeItem('student_token');
                            window.location.href = `student_login.html?redirect_code=${activityCode}`;
                            return;
                        }

                        // 3. å¤„ç†å…¶ä»– HTTP é”™è¯¯
                        if (!response.ok) {
                             throw new Error(resultData.detail || `æœåŠ¡å™¨é”™è¯¯: ${response.status}`);
                        }

                        // 4. å¤„ç†ä¸šåŠ¡é€»è¾‘æ‹’ç» (åç«¯è¿”å› 200 ä½†åŒ…å« detail é”™è¯¯ä¿¡æ¯)
                        //  æ›¿æ¢â€œç»„ç»‡ä¸åŒ¹é…â€çš„ confirm
                        if (resultData.detail) {
                            if (resultData.detail.includes('ç»„ç»‡ä¸åŒ¹é…')) {
                                const result = await Swal.fire({
                                    title: 'åˆ‡æ¢ç™»å½•ç»„ç»‡?',
                                    text: 'æ£€æµ‹åˆ°æ‚¨å½“å‰çš„ç™»å½•èº«ä»½ä¸å±äºè¯¥æ´»åŠ¨æ‰€åœ¨çš„ç»„ç»‡/å­¦æ ¡ã€‚\néœ€è¦é‡æ–°ç™»å½•ä»¥åˆ‡æ¢åˆ°è¯¥ç»„ç»‡å—ï¼Ÿ',
                                    icon: 'question',
                                    showCancelButton: true,
                                    confirmButtonColor: '#007bff',
                                    cancelButtonColor: '#6c757d',
                                    confirmButtonText: 'æ˜¯çš„ï¼Œé‡æ–°ç™»å½•',
                                    cancelButtonText: 'å–æ¶ˆ'
                                });

                                if (result.isConfirmed) {
                                    localStorage.removeItem('student_token');
                                    window.location.href = `student_login.html?redirect_code=${activityCode}`;
                                    return;
                                }
                            } else {
                                // æ™®é€šä¸šåŠ¡é”™è¯¯ (å¦‚ï¼šä¸åœ¨èŒƒå›´å†…)
                                Swal.fire({
                                    icon: 'error',
                                    title: 'æ— æ³•æ“ä½œ',
                                    text: resultData.detail,
                                    confirmButtonColor: '#dc3545'
                                });
                            }
                            // æŠ›å‡ºé”™è¯¯ä»¥ä¸­æ–­åç»­æµç¨‹ (ä¿æŒåŸæœ‰é€»è¾‘ç»“æ„)
                            throw new Error(resultData.detail); 
                        }
                        // 5. æˆåŠŸé€»è¾‘ (æ ¹æ®ç±»å‹æ›´æ–° UI)
                        if (type === 'checkin') {
                            // ç­¾åˆ°æˆåŠŸï¼šè®°å½•ä¸´æ—¶å‡­è¯(å¯é€‰)ï¼Œæ˜¾ç¤ºç­¾é€€æŒ‰é’®
                            localStorage.setItem(tokenStorageKey, resultData.device_session_token);
                            showMessage('ç­¾åˆ°æˆåŠŸ!', false);
                            checkInForm.style.display = 'none';
                            checkOutForm.style.display = 'block';
                        } else {
                            // ç­¾é€€æˆåŠŸï¼šæ¸…é™¤ä¸´æ—¶å‡­è¯ï¼Œéšè—æŒ‰é’®
                            localStorage.removeItem(tokenStorageKey);
                            showMessage('ç­¾é€€æˆåŠŸ!', false);
                            checkOutForm.style.display = 'none';
                            if(studentMarker) studentMarker.hide();
                        }

                    } catch (error) {
                        showMessage(`${error.message}`, true);
                    } finally {
                        checkInButton.disabled = false;
                        checkOutButton.disabled = false;
                    }
                } else {
                    let msg = 'è·å–åœ°ç†ä½ç½®å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯');
                    showMessage(msg, true);
                    checkInButton.disabled = false;
                    checkOutButton.disabled = false;
                }
            });
        }

        function showMessage(msg, isError) {
            messageDiv.innerText = msg;
            messageDiv.className = isError ? 'error' : 'success';
        }
    </script>
</body>
</html>